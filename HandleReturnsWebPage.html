<!DOCTYPE html>
<html lang="en" ng-app="returnsApp">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Handle Returns - Appliance World</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>

  <style>
    :root{--bg:#f8f9fb;--card:#fff;--muted:#6c757d}
    body{background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;padding:28px 12px}
    .card-area{max-width:820px;margin:0 auto;background:var(--card);border-radius:10px;padding:20px;box-shadow:0 8px 30px rgba(17,24,39,0.06);border:1px solid #e9eef5}
    h1{font-size:1.25rem;margin-bottom:8px}
    .form-label.required::after{content:" *";color:#d63384}
    #returnDetails { margin-top: 30px; }
    #resultArea {
        background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px;
        margin-top: 10px; max-height: 300px; overflow-y: auto;
    }
  </style>
</head>

<body ng-controller="ReturnsController">

  <div class="card-area">
    <header class="mb-3">
      <h1>Returns Info</h1>
    </header>

    <form id="returnsForm" class="row g-3" ng-submit="submitReturn($event)">
      <div class="col-12 col-md-4">
        <label class="form-label required">Order ID</label>
        <input type="text" class="form-control" id="orderID" placeholder="Order ID">
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label required">Product ID</label>
        <input type="text" class="form-control" id="productID" placeholder="Product ID">
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label required">Customer Email</label>
        <input type="email" class="form-control" id="customerEmail" placeholder="customer@example.com">
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label required">Return Reason</label>
        <select class="form-select" id="returnReason">
          <option value="">-- Select Reason --</option>
          <option>Defective</option>
          <option>Wrong Item Shipped</option>
          <option>Changed Mind</option>
          <option>Other</option>
        </select>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label required">Return Type</label>
        <select class="form-select" id="returnType">
          <option value="">-- Select Type --</option>
          <option>Refund</option>
          <option>Replacement</option>
          <option>Store Credit</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Comments / Notes</label>
        <textarea class="form-control" id="comments" rows="4" placeholder="Add notes about the return"></textarea>
      </div>

      <div class="col-12 text-end mt-2">
        <a href="index.html" class="btn btn-outline-secondary me-2">Cancel</a>
        <button type="submit" class="btn btn-primary">Record Return</button>
      </div>
    </form>

    <section id="returnDetails" class="mt-4" style="display: none;">
      <h3 class="h5">Return Details (JSON)</h3>
      <pre id="resultArea" class="bg-light p-3 border rounded">Return details will appear here after submission</pre>
    </section>
  </div>

  <script>
  angular.module("returnsApp", [])
  .controller("ReturnsController", function($scope, $http) {

      $scope.submitReturn = function(event) {
          event.preventDefault();

          const orderID = document.getElementById('orderID').value.trim();
          const productID = document.getElementById('productID').value.trim();
          const email = document.getElementById('customerEmail').value.trim();
          const reason = document.getElementById('returnReason').value;
          const type = document.getElementById('returnType').value;
          const commentsVal = document.getElementById('comments').value.trim();

          const orderIDPattern = /^[0-9]+$/;
          const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;

          const allValid = orderIDPattern.test(orderID) && productID !== "" && emailPattern.test(email) && reason !== "" && type !== "";

          if (!allValid) {
              alert("Please complete all required fields correctly.");
              return;
          }

          const returnData = {
              returnId: "RET-" + Date.now() + "-" + Math.floor(Math.random() * 1000),
              orderId: orderID,
              productId: productID,
              customerEmail: email,
              returnDetails: { reason: reason, type: type, comments: commentsVal || "No comments" },
              status: "pending",
              submittedDate: new Date().toISOString()
          };

          document.getElementById('resultArea').textContent = JSON.stringify(returnData, null, 2);
          document.getElementById('returnDetails').style.display = "block";

          // NOTE: Using relative path now!
          $http.post("/api/returns", returnData)
              .then(res => {
                  alert("✅ Return record saved to MongoDB!");
              })
              .catch(err => {
                  console.error(err);
                  alert("❌ Error saving return: " + (err.data ? err.data.message : err.statusText));
              });
      };
  });
  
  // Formatting scripts
  document.getElementById('orderID').addEventListener("input", e => e.target.value = e.target.value.replace(/\D/g, ''));
  document.getElementById('productID').addEventListener("input", e => e.target.value = e.target.value.replace(/[^a-zA-Z0-9]/g, ''));
  </script>

</body>
</html>

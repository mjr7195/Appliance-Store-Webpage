<!doctype html>
<html lang="en">
<!--HTML, CSS, and Bootstrap, Author: Marcos Ruiz-->
<!--Javascript and minor HTML done by: Alex Hammond-->
<!--JSON file display and storage done by: Juan Crespo Jr.-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Shopping Cart - Appliance World</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body{background:#f8f9fb;padding:24px;font-family:system-ui, -apple-system, "Segoe UI", Roboto}
      .card{max-width:980px;margin:0 auto}
      .cart-table td, .cart-table th{vertical-align:middle}
      .qty-input{width:80px}
      .muted-small{font-size:.9rem;color:#6c757d}
      #orderDetails {
        margin-top: 30px;
      }
      #resultArea {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 15px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="card p-4 shadow-sm">
        <div class="mb-3">
            <a href="index.html" class="btn btn-outline-primary">&larr; Return Home</a>
        </div>
      <h1 class="h4 mb-3">Shopping Cart</h1>

      <!-- Add product area: select product from existing products and add to cart -->
      <div class="row g-2 align-items-end mb-4">
        <div class="col-md-6">
          <label class="form-label">Select Product</label>
            <select id="productSelect" class="form-select">
              <option value="">-- choose a product --</option>
            </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantity</label>
          <input id="addQty" type="number" class="form-control" value="1" min="1">
        </div>
        <div class="col-md-2">
          <button id="addBtn" class="btn btn-primary w-100">Add</button>
        </div>
        <div class="col-md-2 text-end muted-small">Items added will appear in the table below.</div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover cart-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Product ID</th>
              <th class="text-end">Price</th>
              <th class="text-center">Quantity</th>
              <th class="text-end">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cartBody">
            <tr id="emptyRow"><td colspan="6" class="text-center text-muted">No items in cart.</td></tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end"><strong>Grand Total</strong></td>
              <td class="text-end"><strong id="grandTotal">$0.00</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="d-flex justify-content-between">
          <button id="clearCart" class="btn btn-outline-secondary">Clear Cart</button>
          <div>
              <button id="showJsonBtn" class="btn btn-info me-2">Show Cart JSON</button>
              <button id="checkoutBtn" class="btn btn-success">Checkout</button>
          </div>
      </div>

      <!-- Order Details JSON Display Section -->
      <section id="orderDetails" class="mt-4" style="display: none;">
        <h3 class="h5">Order Details (JSON)</h3>
        <pre id="resultArea" class="bg-light p-3 border rounded">Order details will appear here after checkout</pre>
      </section>
    </div>

    <script>
      const QuantityField = document.getElementById('addQty');
      QuantityField.addEventListener('input', function () {
          this.value = this.value.replace(/\D/g, '');
          if (this.value < 1) this.value = 1;
      });

      document.addEventListener("DOMContentLoaded", () => {
          const select = document.getElementById("productSelect");
          const storedProducts = localStorage.getItem("products");

          if (storedProducts) {
              try {
                  const products = JSON.parse(storedProducts);

                  // Clear any existing options (keep placeholder)
                  select.innerHTML = '<option value="">-- choose a product --</option>';

                  // Add each product as an option
                  products.forEach(product => {
                      const option = document.createElement("option");
                      // Use product ID as value so you can easily reference it later
                      option.value = product.id;
                      // Display name and price for user clarity
                      option.textContent = `${product.name} - $${parseFloat(product.price).toFixed(2)}`;
                      select.appendChild(option);
                  });
              } catch (err) {
                  console.error("Error parsing products from localStorage:", err);
              }
          } else {
              console.warn("No products found in localStorage.");
          }
      });

      // Handle Add button
      document.getElementById("addBtn").addEventListener("click", () => {
          const select = document.getElementById("productSelect");
          const qtyInput = document.getElementById("addQty");
          const cartBody = document.getElementById("cartBody");
          const emptyRow = document.getElementById("emptyRow");
          const grandTotalEl = document.getElementById("grandTotal");

          const storedProducts = JSON.parse(localStorage.getItem("products") || "[]");
          const productId = select.value;
          const qty = parseInt(qtyInput.value);

          if (!productId || qty < 1) return;

          const product = storedProducts.find(p => p.id == productId);
          if (!product) return;

          // Remove "No items in cart" row
          if (emptyRow) emptyRow.remove();

          const price = parseFloat(product.price);
          const total = price * qty;

          // Create new table row
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${product.name}</td>
              <td>${product.id}</td>
              <td class="text-end">$${price.toFixed(2)}</td>
              <td class="text-center">${qty}</td>
              <td class="text-end">$${total.toFixed(2)}</td>
              <td class="text-end">
                  <button class="btn btn-sm btn-outline-danger removeBtn">Remove</button>
              </td>
          `;

          cartBody.appendChild(row);

          // Update grand total
          updateGrandTotal();

          // Add remove button functionality
          row.querySelector(".removeBtn").addEventListener("click", () => {
              row.remove();
              updateGrandTotal();
              if (!cartBody.children.length) {
                  cartBody.innerHTML = `<tr id="emptyRow"><td colspan="6" class="text-center text-muted">No items in cart.</td></tr>`;
              }
          });

          function updateGrandTotal() {
              let totalSum = 0;
              cartBody.querySelectorAll("tr").forEach(tr => {
                  const cell = tr.querySelector("td:nth-child(5)");
                  if (cell && cell.textContent.startsWith("$")) {
                      totalSum += parseFloat(cell.textContent.replace("$", ""));
                  }
              });
              grandTotalEl.textContent = `$${totalSum.toFixed(2)}`;
          }
      });

      // Clear Cart functionality
      document.getElementById("clearCart").addEventListener("click", () => {
          const cartBody = document.getElementById("cartBody");
          const grandTotalEl = document.getElementById("grandTotal");
          
          cartBody.innerHTML = `<tr id="emptyRow"><td colspan="6" class="text-center text-muted">No items in cart.</td></tr>`;
          grandTotalEl.textContent = "$0.00";
          
          // Hide the order details section when cart is cleared
          document.getElementById("orderDetails").style.display = "none";
      });

      // Checkout functionality - Display JSON
      document.getElementById("checkoutBtn").addEventListener("click", () => {
          const cartBody = document.getElementById("cartBody");
          const emptyRow = document.getElementById("emptyRow");

          // Check if cart is empty
          if (emptyRow || cartBody.children.length === 0) {
              alert("Your cart is empty. Please add items before checking out.");
              return;
          }

          // Collect cart items data
          const cartItems = [];
          let totalAmount = 0;

          cartBody.querySelectorAll("tr").forEach(tr => {
              const cells = tr.querySelectorAll("td");
              if (cells.length >= 5) {
                  const productName = cells[0].textContent;
                  const productId = cells[1].textContent;
                  const price = parseFloat(cells[2].textContent.replace("$", ""));
                  const quantity = parseInt(cells[3].textContent);
                  const total = parseFloat(cells[4].textContent.replace("$", ""));

                  cartItems.push({
                      productId: productId,
                      productName: productName,
                      price: price,
                      quantity: quantity,
                      total: total
                  });

                  totalAmount += total;
              }
          });

          // Create a temporary order object
          const tempOrder = {
              orderId: generateOrderId(),
              orderDate: new Date().toISOString(),
              items: cartItems,
              grandTotal: totalAmount,
              status: "awaiting-shipping"
          };

          // Save temporary order data to localStorage (not final submission)
          localStorage.setItem("tempOrder", JSON.stringify(tempOrder));

          // Also store just the cart items for later restoration
          localStorage.setItem("cartData", JSON.stringify(cartItems));

          // Redirect to shipping selection page
          window.location.href = "ShippingSelectionWebPage.html";

      });


      // Helper function to generate a simple order ID
      function generateOrderId() {
          return 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
      }

      // Helper function to save order to localStorage
      function saveOrderToLocalStorage(order) {
          try {
              // Get existing orders or initialize empty array
              const existingOrders = JSON.parse(localStorage.getItem("orders") || "[]");
              
              // Add new order
              existingOrders.push(order);
              
              // Save back to localStorage
              localStorage.setItem("orders", JSON.stringify(existingOrders));
              
              console.log("Order saved to localStorage:", order.orderId);
          } catch (error) {
              console.error("Error saving order to localStorage:", error);
          }
      }
      // Restore cart if returning from shipping
      document.addEventListener("DOMContentLoaded", () => {
          if (sessionStorage.getItem("restoreCart") === "true") {
              const cartData = JSON.parse(localStorage.getItem("cartData") || "[]");
              if (cartData.length > 0) {
                  const cartBody = document.getElementById("cartBody");
                  const grandTotalEl = document.getElementById("grandTotal");
                  let totalSum = 0;

                  // Clear existing cart rows
                  cartBody.innerHTML = "";

                  // Rebuild each cart row
                  cartData.forEach(item => {
                      const row = document.createElement("tr");
                      row.innerHTML = `
                    <td>${item.productName}</td>
                    <td>${item.productId}</td>
                    <td class="text-end">$${item.price.toFixed(2)}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-end">$${item.total.toFixed(2)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger removeBtn">Remove</button>
                    </td>
                `;
                      cartBody.appendChild(row);
                      totalSum += item.total;

                      // Add remove button functionality
                      row.querySelector(".removeBtn").addEventListener("click", () => {
                          row.remove();
                          updateGrandTotal();
                      });
                  });

                  grandTotalEl.textContent = `$${totalSum.toFixed(2)}`;
              }

              // Clear flag to prevent reloading multiple times
              sessionStorage.removeItem("restoreCart");
          }

          function updateGrandTotal() {
              const grandTotalEl = document.getElementById("grandTotal");
              let totalSum = 0;
              document.querySelectorAll("#cartBody tr").forEach(tr => {
                  const cell = tr.querySelector("td:nth-child(5)");
                  if (cell && cell.textContent.startsWith("$")) {
                      totalSum += parseFloat(cell.textContent.replace("$", ""));
                  }
              });
              grandTotalEl.textContent = `$${totalSum.toFixed(2)}`;
          }
      });
      // Show JSON button functionality
      document.getElementById("showJsonBtn").addEventListener("click", () => {
          const cartData = JSON.parse(localStorage.getItem("cartData") || "[]");
          const orderDetailsSection = document.getElementById("orderDetails");
          const resultArea = document.getElementById("resultArea");

          if (cartData.length === 0) {
              alert("Cart is empty. Add items first.");
              return;
          }

          // Display cart JSON
          resultArea.textContent = JSON.stringify(cartData, null, 2);
          orderDetailsSection.style.display = "block";
      });

    </script>
  </body>
</html>
